---
kind: Pod
apiVersion: v1
metadata:
  name: ${K8S_PROJECT}-dataset-${BRANCH_HASH}
  labels:
    app: ${K8S_PROJECT}-dataset
    git/branch: ${BRANCH_NAME}
    git/commit: ${COMMIT}
    gitlab/job: "${JOB_ID}"
spec:
  containers:
    - image: ${EMJPM_REGISTRY}:${IMAGE_TAG}
      name: ${K8S_PROJECT}-dataset-${BRANCH_HASH}
      command: ["sh"]
      args: ["/dataset/inject-dataset.sh"]
      env:
        - name: DATABASE_URL
          value: "psql://${POSTGRES_API_USER}:${POSTGRES_API_USER_PASSWORD}@${POSTGRES_HOST}/emjpm_dev"
        - name: NODE_ENV
          value: "test"
      volumeMounts:
        - name: dataset
          mountPath: /dataset
      resources:
        requests:
          cpu: 10m
          memory: 32Mi
        limits:
          cpu: 50m
          memory: 64Mi
  volumes:
    - name: dataset
      configMap:
        name: init-postgres
  restartPolicy: Never
  initContainers:
    - name: wait-for-postgres
      image: postgres:10-alpine
      imagePullPolicy: Always
      resources:
        requests:
          cpu: 5m
          memory: 16Mi
        limits:
          cpu: 25m
          memory: 32Mi
      command:
        - sh
        - -c
        - |
          retry=120; # 5s * (12 * 10) = 10min
          while ! pg_isready -h ${POSTGRES_HOST} > /dev/null 2> /dev/null && [[ $(( retry-- )) -gt 0 ]];
            do
              echo "Waiting for Postgres to go Green ($(( retry )))" ; sleep 5s ; done ;
          echo Ready;
