---
include:
  - project: SocialGouv/gitlab-ci-yml
    file: /base_autodevops.yml
    ref: v20.1.2

stages:
  - Install
  - Build
  - Test
  - Registration
  - Release
  - Deploy

Install:
  extends:
    - .autodevops_install

Build:
  stage: Build
  extends: .autodevops_build

# Build api image:
  # stage: Build
  # extends: .autodevops_build
  # variables:

Lint:
  stage: Test
  extends: .autodevops_lint

Test:
  stage: Test
  extends: .autodevops_test
  variables:
    POSTGRES_USER: emjpm
    POSTGRES_PASSWORD: test
  services:
    - postgres:11-alpine


# K8S Test:
#   extends: .autodevops_k8s_test


Register api image:
  extends: .autodevops_register_image
  variables:
    CONTEXT: packages/api
    IMAGE_NAME: $CI_REGISTRY_IMAGE/api

Register app image:
  extends: .autodevops_register_image
  variables:
    CONTEXT: packages/app
    IMAGE_NAME: $CI_REGISTRY_IMAGE/app

Register hasura image:
  extends: .autodevops_register_image
  variables:
    CONTEXT: packages/hasura
    IMAGE_NAME: $CI_REGISTRY_IMAGE/hasura