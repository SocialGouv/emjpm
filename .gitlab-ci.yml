
---

#

include:
  - /.gitlab-ci/variables.yml
  - /.gitlab-ci/extends.yml
  #
  - project: SocialGouv/gitlab-ci-yml
    file: /base_deploy_nodejs_chart_stage.yml
    ref: v3.0.5
  - project: SocialGouv/gitlab-ci-yml
    file: /base_docker_kubectl_image_stage.yml
    ref: v3.0.5
  - project: SocialGouv/gitlab-ci-yml
    file: /base_docker_helm_image_stage.yml
    ref: v3.0.5
  #
  - /.gitlab-ci/stages/notify.yml
  - /.gitlab-ci/stages/deploy.yml
  #
  - /packages/api/.gitlab-ci.yml
  - /packages/app/.gitlab-ci.yml
  - /packages/graphql-server/.gitlab-ci.yml
  - /packages/hasura/.gitlab-ci.yml
  - /packages/knex/.gitlab-ci.yml

#

stages:
- "Prepare"
- "Code Quality"
- "Registration"
- "Deploy"
- "Notify Finished Deployment"

#

.prepare_stage: &prepare_stage
  stage: "Prepare"
  dependencies: []

.quality_stage:
  stage: "Code Quality"
  dependencies: []
  except:
    variables:
      - $PRODUCTION

.register_stage: &register_stage
  stage: "Registration"
  dependencies: []
  except:
    variables:
      - $PRODUCTION
