#!/usr/bin/env bash

function getRandomEmoji {
  emojis=("ğŸµ" "ğŸ’" "ğŸ¦" "ğŸ¶" "ğŸ•" "ğŸ©" "ğŸº" "ğŸ¦Š" "ğŸ±" "ğŸˆ" "ğŸ¦" "ğŸ¯" "ğŸ…" "ğŸ†" "ğŸ´" "ğŸ" "ğŸ¦„" "ğŸ¦“" "ğŸ¦Œ" "ğŸ®" "ğŸ‚" "ğŸƒ" "ğŸ„" "ğŸ·" "ğŸ–" "ğŸ—" "ğŸ½" "ğŸ" "ğŸ‘" "ğŸ" "ğŸª" "ğŸ«" "ğŸ¦’" "ğŸ˜" "ğŸ¦" "ğŸ­" "ğŸ" "ğŸ€" "ğŸ¹" "ğŸ°" "ğŸ‡" "ğŸ¿" "ğŸ¦”" "ğŸ¦‡" "ğŸ»" "ğŸ¨" "ğŸ¼" "ğŸ¾" "ğŸ¦ƒ" "ğŸ”" "ğŸ“" "ğŸ£" "ğŸ¤" "ğŸ¥" "ğŸ¦" "ğŸ§" "ğŸ•Š" "ğŸ¦…" "ğŸ¦†" "ğŸ¦‰" "ğŸ¸" "ğŸŠ" "ğŸ¢" "ğŸ¦" "ğŸ" "ğŸ²" "ğŸ‰" "ğŸ¦•" "ğŸ¦–" "ğŸ³" "ğŸ‹" "ğŸ¬" "ğŸŸ" "ğŸ " "ğŸ¡" "ğŸ¦ˆ" "ğŸ™" "ğŸš" "ğŸ¦€" "ğŸ¦" "ğŸ¦‘" "ğŸŒ" "ğŸ¦‹" "ğŸ›" "ğŸœ" "ğŸ" "ğŸ" "ğŸ¦—" "ğŸ•·" "ğŸ•¸" "ğŸ¦‚" "ğŸ’" "ğŸŒ¸" "ğŸ’®" "ğŸµ" "ğŸŒ¹" "ğŸ¥€" "ğŸŒº" "ğŸŒ»" "ğŸŒ¼" "ğŸŒ·" "ğŸŒ±" "ğŸŒ²" "ğŸŒ³" "ğŸŒ´" "ğŸŒµ" "ğŸŒ¾" "ğŸŒ¿" "â˜˜" "ğŸ€" "ğŸ" "ğŸ‚" "ğŸƒ" "ğŸ‡" "ğŸˆ" "ğŸ‰" "ğŸŠ" "ğŸ‹" "ğŸŒ" "ğŸ" "ğŸ" "ğŸ" "ğŸ" "ğŸ‘" "ğŸ’" "ğŸ“" "ğŸ¥" "ğŸ…" "ğŸ¥¥" "" "ğŸ¥‘" "ğŸ†" "ğŸ¥”" "ğŸ¥•" "ğŸŒ½" "ğŸŒ¶" "ğŸ¥’" "ğŸ¥¦" "ğŸ„" "ğŸ¥œ" ğŸŒ°)
  echo ${emojis[$RANDOM % ${#emojis[@]} ]}
}

function getLastVersionChanges {
  STARTFLAG="false"
  random_emoji=`getRandomEmoji`
  while read LINE; do
    if [ "$STARTFLAG" == "true" ]; then
      if echo "$LINE" | grep -q -P '^## \[((\d+))\.(\d+)\.(\d+)\]'; then
        exit
      else
        echo "$LINE"
      fi
    elif echo "$LINE" | grep -q -P '^## \[(\d+)\.(\d+)\.(\d+)\]'; then
      echo -n "$LINE" | sed -r 's/^## \[(.*)\](.*)\((.*)\)/## '$random_emoji' [\1]\2 (\3)/'
      echo " deploying on production ğŸš€"
      STARTFLAG="true"
      continue
    fi
  done < $1
}

function getDevLink {
  VERSION=`jq -r .version lerna.json`
  VERSION_SLUG=`echo $VERSION | sed 's/\./-/g'`
  echo "-----"
  echo "https://v$VERSION_SLUG-emjpm.dev2.fabrique.social.gouv.fr/"
}

function getReleaseNote {
  getLastVersionChanges CHANGELOG.md | sed '/^$/d'
  getDevLink
}

getReleaseNote