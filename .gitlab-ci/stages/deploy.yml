#

include:
  - /.k8s/app/.k8s-deploy-app.yml
  - /.k8s/api/.k8s-deploy-api.yml

#

.deploy_stage: &deploy_stage
  stage: "Deploy"
  dependencies: []
  services:
    - docker:dind
  variables: &deploy_stage_variables
    IMAGE_TAG: $CI_COMMIT_SHA
    REGISTRY: $CI_REGISTRY_IMAGE

.incubateur_stage: &incubateur_stage
  environment:
    name: incubateur
  only:
    - tags

.dev_stage: &dev_stage
  environment:
    name: dev.factory
  only:
    - branches

.docker_kube_dev_stage: &docker_kube_dev_stage
  before_script:
    - source ./.gitlab-ci/env.sh

#
#
#

.deploy-frontend: &deploy_frontend
  <<: *deploy_stage
  <<: *docker_kube_dev_stage
  variables:
    <<: *deploy_stage_variables
    CI_DEBUG_TRACE: "true"
    CONTEXT: app
    IMAGE_NAME: $CI_REGISTRY_IMAGE/app
    PORT: 80
  after_script:
    - echo "Frontend available at - ${FRONTEND_HOST}"

#

Deploy App (dev):
  extends: .k8s-deploy-app-dev
  <<: *deploy_frontend
  <<: *dev_stage

Deploy App (incubateur):
  extends: .k8s-deploy-app-prod
  <<: *deploy_frontend
  <<: *incubateur_stage

#
#
#

.deploy-api: &deploy_api
  <<: *deploy_stage
  variables:
    <<: *deploy_stage_variables
    CONTEXT: api
    IMAGE_NAME: $CI_REGISTRY_IMAGE/api
    PORT: 4000
  after_script:
    - echo "Api available at - ${API_HOST}"

#

Deploy Api (dev):
  extends: .k8s-deploy-api-dev
  <<: *deploy_api
  <<: *dev_stage
  <<: *docker_kube_dev_stage

Deploy Api (incubateur):
  extends: .k8s-deploy-api-prod
  <<: *deploy_api
  <<: *incubateur_stage
  <<: *docker_kube_dev_stage
