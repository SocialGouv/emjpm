---
dist: xenial

language: node_js
node_js: 10

cache: yarn
git:
  depth: 5

#

before_install:
  - curl -o- -L https://yarnpkg.com/install.sh | bash
  - export PATH="$HOME/.yarn/bin:$PATH
before_script:
  - docker-compose up -d db
  - docker-compose exec db createdb emjpm_test -U postgres
  - yarn workspace @socialgouv/api knex migrate:latest --env test
  - yarn workspace @socialgouv/api knex seed:run --env test

script:
  - yarn build --stream
  - yarn lint --stream
  - yarn workspace @socialgouv/app test --coverage
  - JWTKEY=lol yarn workspace @socialgouv/api test
after_success: npx codecov
