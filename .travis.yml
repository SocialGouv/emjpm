---
dist: xenial

language: node_js
node_js: 10

cache: yarn
git:
  depth: 5

#

before_install:
  # Start the database first so it has the time to boot before we interact with it.
  - docker-compose up -d db
  - curl -o- -L https://yarnpkg.com/install.sh | bash
  - export PATH="$HOME/.yarn/bin:$PATH"

before_script:
  - yarn workspace @socialgouv/api knex migrate:latest --env test
  - yarn workspace @socialgouv/api knex seed:run --env test

script:
  - yarn build --stream
  - yarn lint --stream
  - yarn workspace @socialgouv/app test --coverage
  - JWTKEY=lol yarn workspace @socialgouv/api test

after_script:
  - npx codecov
  - docker-compose down
